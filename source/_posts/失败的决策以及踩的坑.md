title: 失败的决策以及踩的坑
date: 2016-09-22 22:57:50
tags:
 - rails
 - gem
 - cancancan
 - active-model-serializers
 - jsonapi
 - 日常
---

### 近期来了一堆紧急需求，然而我为了有更多地时间摸鱼，我做了几个愚蠢的决定
  1. 使用`active_model_serializers`的jsonapi adapter(为了`追求`jsonapi spec)
  2. 使用`cancancan`作角色权限验证
  3. 编写大量的`测试`

### jsonapi spec
  本身spec的宗旨是希望通过一定的`convetion`(约定)来帮助开发者规范json schema 统一好json schema的格式。
然而我对这个spec也只是停留在了解的程度，还没能够对它的整套规范做出良好的据测，由于不清楚它所谓的几个“MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “MAY”, and “OPTIONAL”。
再加上为了偷懒，我选择了`active_model_serializers`，发现并没有想象中的真的节约了我多少时间，还是大部分时间再去看它的源码以及开源社区里的issue支撑我现在的需求。  
在读源码&jsonapi spec的过程中发现，项目里也只有序列化的部分用到了jsonapi的spec，接口的更新，创建，查询，排序等还是依着需求，写的也比较随意。

### 权限验证的坑
  之前在暴漫做的项目,权限验证用是`pundit`，后来随着需求不断的更改，大家觉得写policy很折腾，于是同事把它逐渐换成了`cancancan`，为了满足变化快的需求，我们把权限数据放入了数据库里，给管理员提供了一套编辑的功能。
使用了一段时间发现这套方案在`cancancan`的帮助下还是很方便的，把permission挂载ability下面。对于需要验证的部分加macro就可以了。  
由于之前的场景是内部系统，用户不会很多，也不会因为每次权限都要从数据库里查询带来多少体验上的影响。  
于是决定继续使用数据表+`cancancan`的方案，但是现在场景是面对互联网用户，为了让服务器充分的发挥它的三维，让用户感受到服务器爸爸的伟大。决定给权限验证加缓存。
起初我以为根据用户的cache_key把`ability`实例丢进了缓存里就可以了，结果被服务器告知`实例里有一些无法被序列化的对象`。为了给权限加缓存，又去看了下`cancancan`的源码（真的是浪费时间。。）。
发现`cancancan`内部有一个rules对象，通过把权限记录在rules里来实现权限验证，rules是一个简单地对象符合ruby的序列化二进制数据的规范。只要把rules序列化缓存就好了。

### 写测试的意义在哪里？
  权限做好了，下面要把相关的接口都测一遍，因为懒不喜欢用GUI点来点去觉得脚本测试很方便，又怕考虑的不全面，于是我模拟了我考虑到的所有场景。浪费太多时间在写测试上面。
在后面对需求和接口格式的时候发现，不少测试都是无用功，有的是因为功能变了，有的是json结构不满足前端的交互，jsonapi那套schema也没覆盖到。

### 总结
  面对紧急需求，应当选择自己熟悉工具，以后不滥用gem，选择遵守某种约定的时候应当从实现、使用以及维护的角度来决策。只针对稳定or复杂的需求编写覆盖性的测试用例。抽时间读常用gem的源码。